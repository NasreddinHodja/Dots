#!/usr/bin/env python3
import os
import json
import random

DIR = os.path.expanduser("~/Pictures/wp/")
STATE_FILE = os.path.expanduser("~/Dots/wp.state.json")

if os.path.exists(STATE_FILE):
    with open(STATE_FILE) as f:
        state = json.load(f)
else:
    state = {"files": [], "index": 0}

files = [f for f in os.listdir(DIR) if os.path.isfile(os.path.join(DIR, f))]

if state["index"] >= len(state["files"]) or set(files) != set(state["files"]):
    random.shuffle(files)
    state = {"files": files, "index": 0}

if state["files"]:
    next_file = os.path.join(DIR, state["files"][state["index"]])

    os.system(f"~/.local/bin/setbg '{next_file}'")

    state["index"] += 1

with open(STATE_FILE, 'w') as f:
    json.dump(state, f)
