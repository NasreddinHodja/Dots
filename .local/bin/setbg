#!/usr/bin/env bash
set -e

mode="cover"

if [ "$1" = "--tile" ]; then
    mode="tile"
    shift
fi

apply_wp() {
    local img="$1"
    local conf="$HOME/.config/hypr/hyprpaper.conf"
    local wp="$img"

    [ "$mode" != "cover" ] && wp="$mode:$img"

    mkdir -p "$HOME/.config/hypr"

    {
        echo "preload = $img"
        echo "wallpaper = ,$wp"
    } > "$conf"

    hyprctl hyprpaper reload ,$wp
}

if [ $# -ne 1 ]; then
    WP=$(printf '%s\n' ~/.config/wp.* | head -n 1)
    if [ -z "$WP" ]; then exit 1; fi
    apply_wp "$WP"
    exit 0
fi

IMAGE_FILE="$1"

if [ ! -f "$IMAGE_FILE" ]; then exit 1; fi
if ! command -v identify >/dev/null; then exit 1; fi

EXT="${IMAGE_FILE##*.}"
CONFIG_FILE="$HOME/.config/wp.$EXT"

mkdir -p ~/.config
rm -f ~/.config/wp.*
cp "$IMAGE_FILE" "$CONFIG_FILE"

WP=$(printf '%s\n' ~/.config/wp.* | head -n 1)
apply_wp "$WP"
