#!/usr/bin/env bash

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <image_file>"
    exit 1
fi

IMAGE_FILE="$1"

if [ ! -f "$IMAGE_FILE" ]; then
    echo "Error: File '$IMAGE_FILE' does not exist."
    exit 1
fi

if ! command -v identify >/dev/null; then
    echo "Error: ImageMagick (identify) is required."
    exit 1
fi

EXT="${IMAGE_FILE##*.}"
CONFIG_FILE="$HOME/.config/wp.$EXT"

mkdir -p ~/.config
rm -f ~/.config/wp.*
cp "$IMAGE_FILE" "$CONFIG_FILE"

# detect image dimensions
set +e
read WIDTH HEIGHT < <(identify -format "%w %h" "$IMAGE_FILE" 2>/dev/null)
set -e
echo $WIDTH

if [ -z "$WIDTH" ] || [ -z "$HEIGHT" ]; then
    echo "Error: could not read image dimensions."
    exit 1
fi

# determine mode based on size
# 5 = stretched (default), 2 = tiled
if [ "$WIDTH" -le 600 ] && [ "$HEIGHT" -le 600 ]; then
    STYLE=2
else
    STYLE=5
fi

xfconf-query -c xfce4-desktop -p /backdrop/single-workspace-mode -s true

MONITORS=$(xrandr --listmonitors | awk 'NR>1 {print $4}')

for monitor in $MONITORS; do
    xfconf-query -c xfce4-desktop -p "/backdrop/screen0/monitor$monitor/workspace0/last-image" -s "$IMAGE_FILE"
    xfconf-query -c xfce4-desktop -p "/backdrop/screen0/monitor$monitor/workspace0/last-image" -s "$CONFIG_FILE"
    xfconf-query -c xfce4-desktop -p "/backdrop/screen0/monitor$monitor/workspace0/image-style" -s "$STYLE"
done
