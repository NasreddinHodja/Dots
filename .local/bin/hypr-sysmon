#!/bin/bash

cpu_usage=$(top -bn1 | awk '/Cpu/ {printf "%.1f", $2 + $4}')
cpu_usage=$(printf "%05.1f" "$cpu_usage")

mem_info=$(free -h | awk '/Mem/ {printf "%.1f|%s|%s", $3/$2*100, $3, $2}')
mem_percent=$(printf "%05.1f" "$(cut -d'|' -f1 <<< "$mem_info")")
mem_used=$(cut -d'|' -f2 <<< "$mem_info")
mem_total=$(cut -d'|' -f3 <<< "$mem_info")

disk_info=$(df -h / | awk 'NR==2 {gsub(/%/, "", $5); printf "%.1f|%s|%s", $5, $3, $2}')
disk_percent=$(printf "%05.1f" "$(cut -d'|' -f1 <<< "$disk_info")")
disk_used=$(cut -d'|' -f2 <<< "$disk_info")
disk_total=$(cut -d'|' -f3 <<< "$disk_info")

cpu_icon=" "
ram_icon="󰘚 "
disk_icon="󰆼 "

text="${cpu_icon} ${cpu_usage}% | ${ram_icon} ${mem_percent}% <span fgcolor='#888888'>(${mem_used}/${mem_total})</span> | ${disk_icon} ${disk_percent}% <span fgcolor='#888888'>(${disk_used}/${disk_total})</span>"

uptime_info=$(uptime -p)
load_avg=$(uptime | awk -F'load average:' '{print $2}' | xargs)

top_processes=$(ps aux --sort=-%cpu --no-headers | head -3 | awk '{printf "%s: %.1f%%\n", $11, $3}')

tooltip=$(cat <<EOF
<b>System Monitor</b>

<b>CPU:</b> ${cpu_usage}%
<b>Load Avg:</b> ${load_avg}

<b>Memory:</b> ${mem_used} / ${mem_total} (${mem_percent}%)

<b>Disk (/):</b> ${disk_used} / ${disk_total} (${disk_percent}%)

<b>Uptime:</b> ${uptime_info}

<b>Top CPU Processes:</b>
${top_processes}
EOF
)

json_escape() {
  sed ':a;N;$!ba; s/\\/\\\\/g; s/"/\\"/g; s/\n/\\n/g'
}

printf '{"text":"%s","tooltip":"%s"}\n' \
  "$(printf "%s" "$text" | json_escape)" \
  "$(printf "%s" "$tooltip" | json_escape)"
